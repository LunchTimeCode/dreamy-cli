# Workflow to build your docs with oranda (and mdbook)
# and deploy them to Github Pages
name: Web

on:
 workflow_run:
  workflows: [ "Release" ]
  types:
    - completed
  jobs:
    web:
      name: Build and deploy site and docs
      runs-on: ubuntu-latest
      steps:
          # Setup
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0
        - uses: dtolnay/rust-toolchain@stable
        - uses: swatinem/rust-cache@v2

        # If you use any mdbook plugins, here's the place to install them!

        # Install and run oranda (and mdbook)
        # This will write all output to ./public/ (including copying mdbook's output to there)
        - name: Install and run oranda
          run: |
            curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/oranda/releases/download/v0.4.0/oranda-installer.sh | sh
            oranda build

        - name: Prepare HTML for link checking
          # untitaker/hyperlink supports no site prefixes, move entire site into
          # a subfolder
          run: mkdir /tmp/public/ && cp -R public /tmp/public/oranda

        - name: Check HTML for broken internal links
          uses: untitaker/hyperlink@0.1.29
          with:
            args: /tmp/public/ --sources docs/

          # Deploy to our gh-pages branch (creating it if it doesn't exist)
          # the "public" dir that oranda made above will become the root dir
          # of this branch.
          #
          # Note that once the gh-pages branch exists, you must
          # go into repo's settings > pages and set "deploy from branch: gh-pages"
          # the other defaults work fine.
        - name: Deploy to Github Pages
          uses: JamesIves/github-pages-deploy-action@v4.4.1
            # ONLY if we're on main (so no PRs or feature branches allowed!)
          if: ${{ github.ref == 'refs/heads/main' }}
          with:
            branch: gh-pages
            # Gotta tell the action where to find oranda's output
            folder: public
            token: ${{ secrets.GLOBAL_GITHUB_TOKEN }}
            single-commit: true